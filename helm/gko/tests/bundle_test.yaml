# Copyright (C) 2015 The Gravitee team (http://gravitee.io)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test bundle
templates:
  - "bundle.yaml"
tests:
  - it: Should nest all needed resources
    asserts:
      - hasDocuments:
          count: 11

  - it: Should have manager service account in release namespace
    documentIndex: 0
    asserts:
      - isKind:
          of: ServiceAccount
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: Should have leader election role in release namespace
    documentIndex: 1
    asserts:
      - isKind:
          of: Role
      - isAPIVersion:
          of: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: metadata.name
          value: gko-leader-election-role-RELEASE-NAME-NAMESPACE

  - it: Should have manager cluster role
    documentIndex: 2
    asserts:
      - isKind:
          of: ClusterRole
      - isAPIVersion:
          of: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.name
          value: gko-manager-role-RELEASE-NAME-NAMESPACE

  - it: Should have metrics cluster role
    documentIndex: 3
    asserts:
      - isKind:
          of: ClusterRole
      - isAPIVersion:
          of: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.name
          value: gko-metrics-reader-RELEASE-NAME-NAMESPACE

  - it: Should have proxy cluster role
    documentIndex: 4
    asserts:
      - isKind:
          of: ClusterRole
      - isAPIVersion:
          of: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.name
          value: gko-proxy-role-RELEASE-NAME-NAMESPACE


  - it: Should have leader election role binding in release namespace
    documentIndex: 5
    asserts:
      - isKind:
          of: RoleBinding
      - isAPIVersion:
          of: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.name
          value: gko-leader-election-rolebinding
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: Should have manager cluster role binding
    documentIndex: 6
    asserts:
      - isKind:
          of: ClusterRoleBinding
      - isAPIVersion:
          of: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.name
          value: gko-manager-rolebinding-RELEASE-NAME-NAMESPACE

  - it: Should have proxy cluster role binding
    documentIndex: 7
    asserts:
      - isKind:
          of: ClusterRoleBinding
      - isAPIVersion:
          of: rbac.authorization.k8s.io/v1
      - equal:
          path: metadata.name
          value: gko-proxy-rolebinding-RELEASE-NAME-NAMESPACE

  - it: Should have manager config in release namespace
    documentIndex: 8
    asserts:
      - isKind:
          of: ConfigMap
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: gko-manager-config
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: Should have a manager https service in release namespace
    documentIndex: 9
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: gko-controller-manager-metrics-service
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: spec.ports[0].name
          value: https
      - equal:
          path: spec.ports[0].port
          value: 8443
      - equal:
          path: spec.selector.control-plane
          value: controller-manager

  - it: Should have a controller manager deployment in release namespace
    documentIndex: 10
    asserts:
      - isKind:
          of: Deployment
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: gko-controller-manager
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: metadata.labels.control-plane
          value: controller-manager


