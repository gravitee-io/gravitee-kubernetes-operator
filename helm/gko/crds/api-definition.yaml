# Copyright (C) 2015 The Gravitee team (http://gravitee.io)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)
    controller-gen.kubebuilder.io/version: v0.11.1
  name: apidefinitions.gravitee.io
spec:
  group: gravitee.io
  names:
    kind: ApiDefinition
    listKind: ApiDefinitionList
    plural: apidefinitions
    shortNames:
      - graviteeapis
    singular: apidefinition
  scope: Namespaced
  versions:
    - additionalPrinterColumns:
        - description: API entrypoint.
          jsonPath: .spec.proxy.virtual_hosts[*].path
          name: Entrypoint
          type: string
        - description: API endpoint.
          jsonPath: .spec.proxy.groups[*].endpoints[*].target
          name: Endpoint
          type: string
        - description: API version.
          jsonPath: .spec.version
          name: Version
          type: string
      name: v1alpha1
      schema:
        openAPIV3Schema:
          description: ApiDefinition is the Schema for the apidefinitions API.
          properties:
            apiVersion:
              description: 'APIVersion defines the versioned schema of this representation of
                an object. Servers should convert recognized schemas to the
                latest internal value, and may reject unrecognized values. More
                info:
                https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
              type: string
            kind:
              description: 'Kind is a string value representing the REST resource this object
                represents. Servers may infer this from the endpoint the client
                submits requests to. Cannot be updated. In CamelCase. More info:
                https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
              type: string
            metadata:
              type: object
            spec:
              description: The API definition is the main resource handled by the Kubernetes
                Operator Most of the configuration properties defined here are
                already documented in the APIM Console API Reference. See
                https://docs.gravitee.io/apim/3.x/apim_installguide_rest_apis_documentation.html
              properties:
                contextRef:
                  properties:
                    name:
                      type: string
                    namespace:
                      type: string
                  required:
                    - name
                  type: object
                crossId:
                  type: string
                definition_context:
                  description: The definition context is used to inform a management API instance
                    that this API definition is managed using a kubernetes
                    operator
                  properties:
                    mode:
                      default: fully_managed
                      type: string
                    origin:
                      default: kubernetes
                      type: string
                  type: object
                deployedAt:
                  format: int64
                  type: integer
                description:
                  type: string
                flow_mode:
                  default: DEFAULT
                  enum:
                    - DEFAULT
                    - BEST_MATCH
                  type: string
                flows:
                  items:
                    properties:
                      condition:
                        type: string
                      consumers:
                        items:
                          properties:
                            consumerId:
                              type: string
                            consumerType:
                              type: integer
                          type: object
                        type: array
                      enabled:
                        default: true
                        type: boolean
                      id:
                        type: string
                      methods:
                        items:
                          enum:
                            - GET
                            - POST
                            - PUT
                            - PATCH
                            - DELETE
                            - OPTIONS
                            - HEAD
                            - CONNECT
                            - TRACE
                            - OTHER
                          type: string
                        type: array
                      name:
                        type: string
                      path-operator:
                        properties:
                          operator:
                            default: STARTS_WITH
                            enum:
                              - STARTS_WITH
                              - EQUALS
                            type: string
                          path:
                            type: string
                        type: object
                      post:
                        items:
                          properties:
                            condition:
                              type: string
                            configuration:
                              type: object
                              x-kubernetes-preserve-unknown-fields: true
                            description:
                              type: string
                            enabled:
                              type: boolean
                            name:
                              type: string
                            policy:
                              type: string
                          type: object
                        type: array
                      pre:
                        items:
                          properties:
                            condition:
                              type: string
                            configuration:
                              type: object
                              x-kubernetes-preserve-unknown-fields: true
                            description:
                              type: string
                            enabled:
                              type: boolean
                            name:
                              type: string
                            policy:
                              type: string
                          type: object
                        type: array
                    required:
                      - enabled
                    type: object
                  type: array
                gravitee:
                  default: 2.0.0
                  type: string
                id:
                  description: io.gravitee.definition.model.Api
                  type: string
                labels:
                  items:
                    type: string
                  type: array
                lifecycle_state:
                  default: CREATED
                  enum:
                    - CREATED
                    - PUBLISHED
                    - UNPUBLISHED
                    - DEPRECATED
                    - ARCHIVED
                  type: string
                local:
                  default: true
                  description: "local defines if the api is local or not.\ 

                    \ If true, the Operator will create the
                    ConfigMaps for the Gateway and pushes the API to the
                    Management API but without setting the update flag in the
                    datastore.\ 

                    \ If false, the Operator will not create
                    the ConfigMaps for the Gateway. Instead, it pushes the API
                    to the Management API and forces it to update the event in
                    the datastore. This will cause Gateways to fetch the APIs
                    from the datastore"
                  type: boolean
                metadata:
                  items:
                    properties:
                      defaultValue:
                        type: string
                      format:
                        enum:
                          - STRING
                          - NUMERIC
                          - BOOLEAN
                          - DATE
                          - MAIL
                          - URL
                        type: string
                      key:
                        type: string
                      name:
                        type: string
                      value:
                        type: string
                    required:
                      - format
                      - key
                      - name
                    type: object
                  type: array
                name:
                  type: string
                path_mappings:
                  items:
                    type: string
                  type: array
                plans:
                  items:
                    properties:
                      api:
                        type: string
                      characteristics:
                        items:
                          type: string
                        type: array
                      comment_required:
                        type: boolean
                      crossId:
                        type: string
                      description:
                        type: string
                      excluded_groups:
                        items:
                          type: string
                        type: array
                      flows:
                        items:
                          properties:
                            condition:
                              type: string
                            consumers:
                              items:
                                properties:
                                  consumerId:
                                    type: string
                                  consumerType:
                                    type: integer
                                type: object
                              type: array
                            enabled:
                              default: true
                              type: boolean
                            id:
                              type: string
                            methods:
                              items:
                                enum:
                                  - GET
                                  - POST
                                  - PUT
                                  - PATCH
                                  - DELETE
                                  - OPTIONS
                                  - HEAD
                                  - CONNECT
                                  - TRACE
                                  - OTHER
                                type: string
                              type: array
                            name:
                              type: string
                            path-operator:
                              properties:
                                operator:
                                  default: STARTS_WITH
                                  enum:
                                    - STARTS_WITH
                                    - EQUALS
                                  type: string
                                path:
                                  type: string
                              type: object
                            post:
                              items:
                                properties:
                                  condition:
                                    type: string
                                  configuration:
                                    type: object
                                    x-kubernetes-preserve-unknown-fields: true
                                  description:
                                    type: string
                                  enabled:
                                    type: boolean
                                  name:
                                    type: string
                                  policy:
                                    type: string
                                type: object
                              type: array
                            pre:
                              items:
                                properties:
                                  condition:
                                    type: string
                                  configuration:
                                    type: object
                                    x-kubernetes-preserve-unknown-fields: true
                                  description:
                                    type: string
                                  enabled:
                                    type: boolean
                                  name:
                                    type: string
                                  policy:
                                    type: string
                                type: object
                              type: array
                          required:
                            - enabled
                          type: object
                        type: array
                      id:
                        type: string
                      name:
                        type: string
                      order:
                        type: integer
                      paths:
                        additionalProperties:
                          items:
                            properties:
                              description:
                                type: string
                              enabled:
                                type: boolean
                              methods:
                                items:
                                  enum:
                                    - GET
                                    - POST
                                    - PUT
                                    - PATCH
                                    - DELETE
                                    - OPTIONS
                                    - HEAD
                                    - CONNECT
                                    - TRACE
                                    - OTHER
                                  type: string
                                type: array
                              policy:
                                properties:
                                  configuration:
                                    type: object
                                    x-kubernetes-preserve-unknown-fields: true
                                  name:
                                    type: string
                                type: object
                            type: object
                          type: array
                        type: object
                      security:
                        type: string
                      securityDefinition:
                        type: string
                      selectionRule:
                        type: string
                      status:
                        default: PUBLISHED
                        enum:
                          - STAGING
                          - PUBLISHED
                          - CLOSED
                          - DEPRECATED
                        type: string
                      tags:
                        items:
                          type: string
                        type: array
                      type:
                        default: API
                        enum:
                          - API
                          - CATALOG
                        type: string
                      validation:
                        default: AUTO
                        enum:
                          - AUTO
                          - MANUAL
                        type: string
                    required:
                      - description
                      - name
                      - security
                    type: object
                  type: array
                primaryOwner:
                  properties:
                    displayName:
                      type: string
                    email:
                      type: string
                    id:
                      type: string
                    type:
                      type: string
                  required:
                    - displayName
                    - email
                    - id
                    - type
                  type: object
                properties:
                  items:
                    properties:
                      encrypted:
                        type: boolean
                      key:
                        type: string
                      value:
                        type: string
                    type: object
                  type: array
                proxy:
                  properties:
                    cors:
                      properties:
                        allowCredentials:
                          type: boolean
                        allowHeaders:
                          items:
                            type: string
                          type: array
                        allowMethods:
                          items:
                            type: string
                          type: array
                        allowOrigin:
                          items:
                            type: string
                          type: array
                        enabled:
                          type: boolean
                        exposeHeaders:
                          items:
                            type: string
                          type: array
                        maxAge:
                          type: integer
                        runPolicies:
                          default: false
                          type: boolean
                      required:
                        - allowCredentials
                        - enabled
                        - maxAge
                      type: object
                    failover:
                      properties:
                        cases:
                          items:
                            type: string
                          type: array
                        maxAttempts:
                          type: integer
                        retryTimeout:
                          format: int64
                          type: integer
                      type: object
                    groups:
                      items:
                        properties:
                          endpoints:
                            items:
                              properties:
                                '-':
                                  type: integer
                                backup:
                                  type: boolean
                                headers:
                                  items:
                                    properties:
                                      name:
                                        type: string
                                      value:
                                        type: string
                                    type: object
                                  type: array
                                healthcheck:
                                  properties:
                                    enabled:
                                      default: false
                                      type: boolean
                                    inherit:
                                      type: boolean
                                    schedule:
                                      type: string
                                    steps:
                                      description: HealthCheckService
                                      items:
                                        properties:
                                          name:
                                            type: string
                                          request:
                                            properties:
                                              body:
                                                type: string
                                              fromRoot:
                                                type: boolean
                                              headers:
                                                items:
                                                  properties:
                                                    name:
                                                      type: string
                                                    value:
                                                      type: string
                                                  type: object
                                                type: array
                                              method:
                                                enum:
                                                  - GET
                                                  - POST
                                                  - PUT
                                                  - PATCH
                                                  - DELETE
                                                  - OPTIONS
                                                  - HEAD
                                                  - CONNECT
                                                  - TRACE
                                                  - OTHER
                                                type: string
                                              path:
                                                type: string
                                            type: object
                                          response:
                                            properties:
                                              assertions:
                                                items:
                                                  type: string
                                                type: array
                                            type: object
                                        type: object
                                      type: array
                                  required:
                                    - enabled
                                  type: object
                                http:
                                  properties:
                                    clearTextUpgrade:
                                      type: boolean
                                    connectTimeout:
                                      format: int64
                                      type: integer
                                    followRedirects:
                                      type: boolean
                                    idleTimeout:
                                      format: int64
                                      type: integer
                                    keepAlive:
                                      type: boolean
                                    maxConcurrentConnections:
                                      type: integer
                                    pipelining:
                                      type: boolean
                                    readTimeout:
                                      format: int64
                                      type: integer
                                    useCompression:
                                      type: boolean
                                    version:
                                      type: string
                                  type: object
                                inherit:
                                  type: boolean
                                name:
                                  description: From Endpoint
                                  type: string
                                proxy:
                                  properties:
                                    enabled:
                                      type: boolean
                                    host:
                                      type: string
                                    password:
                                      type: string
                                    port:
                                      type: integer
                                    type:
                                      type: string
                                    useSystemProxy:
                                      type: boolean
                                    username:
                                      type: string
                                  type: object
                                ssl:
                                  properties:
                                    hostnameVerifier:
                                      type: boolean
                                    keyStore:
                                      properties:
                                        type:
                                          type: string
                                      type: object
                                    trustAll:
                                      type: boolean
                                    trustStore:
                                      properties:
                                        type:
                                          type: string
                                      type: object
                                  type: object
                                target:
                                  type: string
                                tenants:
                                  items:
                                    type: string
                                  type: array
                                type:
                                  type: string
                                weight:
                                  type: integer
                              type: object
                            type: array
                          headers:
                            additionalProperties:
                              type: string
                            type: object
                          http:
                            properties:
                              clearTextUpgrade:
                                type: boolean
                              connectTimeout:
                                format: int64
                                type: integer
                              followRedirects:
                                type: boolean
                              idleTimeout:
                                format: int64
                                type: integer
                              keepAlive:
                                type: boolean
                              maxConcurrentConnections:
                                type: integer
                              pipelining:
                                type: boolean
                              readTimeout:
                                format: int64
                                type: integer
                              useCompression:
                                type: boolean
                              version:
                                type: string
                            type: object
                          load_balancing:
                            properties:
                              type:
                                type: string
                            type: object
                          name:
                            type: string
                          proxy:
                            properties:
                              enabled:
                                type: boolean
                              host:
                                type: string
                              password:
                                type: string
                              port:
                                type: integer
                              type:
                                type: string
                              useSystemProxy:
                                type: boolean
                              username:
                                type: string
                            type: object
                          services:
                            properties:
                              discovery:
                                properties:
                                  configuration:
                                    type: object
                                    x-kubernetes-preserve-unknown-fields: true
                                  enabled:
                                    type: boolean
                                  name:
                                    type: string
                                  provider:
                                    type: string
                                required:
                                  - enabled
                                type: object
                              dynamic-property:
                                properties:
                                  provider:
                                    type: integer
                                  schedule:
                                    type: string
                                type: object
                              health-check:
                                properties:
                                  enabled:
                                    default: false
                                    type: boolean
                                  schedule:
                                    type: string
                                  steps:
                                    items:
                                      properties:
                                        name:
                                          type: string
                                        request:
                                          properties:
                                            body:
                                              type: string
                                            fromRoot:
                                              type: boolean
                                            headers:
                                              items:
                                                properties:
                                                  name:
                                                    type: string
                                                  value:
                                                    type: string
                                                type: object
                                              type: array
                                            method:
                                              enum:
                                                - GET
                                                - POST
                                                - PUT
                                                - PATCH
                                                - DELETE
                                                - OPTIONS
                                                - HEAD
                                                - CONNECT
                                                - TRACE
                                                - OTHER
                                              type: string
                                            path:
                                              type: string
                                          type: object
                                        response:
                                          properties:
                                            assertions:
                                              items:
                                                type: string
                                              type: array
                                          type: object
                                      type: object
                                    type: array
                                required:
                                  - enabled
                                type: object
                            type: object
                          ssl:
                            properties:
                              hostnameVerifier:
                                type: boolean
                              keyStore:
                                properties:
                                  type:
                                    type: string
                                type: object
                              trustAll:
                                type: boolean
                              trustStore:
                                properties:
                                  type:
                                    type: string
                                type: object
                            type: object
                        type: object
                      type: array
                    logging:
                      properties:
                        condition:
                          type: string
                        content:
                          enum:
                            - NONE
                            - HEADERS
                            - PAYLOADS
                            - HEADERS_PAYLOADS
                          type: string
                        mode:
                          enum:
                            - NONE
                            - CLIENT
                            - PROXY
                            - CLIENT_PROXY
                          type: string
                        scope:
                          enum:
                            - NONE
                            - REQUEST
                            - RESPONSE
                            - REQUEST_RESPONSE
                          type: string
                      type: object
                    preserve_host:
                      type: boolean
                    strip_context_path:
                      type: boolean
                    virtual_hosts:
                      items:
                        properties:
                          host:
                            type: string
                          override_entrypoint:
                            type: boolean
                          path:
                            type: string
                        type: object
                      type: array
                  type: object
                resources:
                  items:
                    properties:
                      configuration:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      enabled:
                        type: boolean
                      name:
                        type: string
                      ref:
                        properties:
                          name:
                            type: string
                          namespace:
                            type: string
                        required:
                          - name
                        type: object
                      type:
                        type: string
                    type: object
                  type: array
                response_templates:
                  additionalProperties:
                    additionalProperties:
                      properties:
                        body:
                          type: string
                        headers:
                          additionalProperties:
                            type: string
                          type: object
                        status:
                          type: integer
                      type: object
                    type: object
                  type: object
                services:
                  properties:
                    discovery:
                      properties:
                        configuration:
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                        enabled:
                          type: boolean
                        name:
                          type: string
                        provider:
                          type: string
                      required:
                        - enabled
                      type: object
                    dynamic-property:
                      properties:
                        provider:
                          type: integer
                        schedule:
                          type: string
                      type: object
                    health-check:
                      properties:
                        enabled:
                          default: false
                          type: boolean
                        schedule:
                          type: string
                        steps:
                          items:
                            properties:
                              name:
                                type: string
                              request:
                                properties:
                                  body:
                                    type: string
                                  fromRoot:
                                    type: boolean
                                  headers:
                                    items:
                                      properties:
                                        name:
                                          type: string
                                        value:
                                          type: string
                                      type: object
                                    type: array
                                  method:
                                    enum:
                                      - GET
                                      - POST
                                      - PUT
                                      - PATCH
                                      - DELETE
                                      - OPTIONS
                                      - HEAD
                                      - CONNECT
                                      - TRACE
                                      - OTHER
                                    type: string
                                  path:
                                    type: string
                                type: object
                              response:
                                properties:
                                  assertions:
                                    items:
                                      type: string
                                    type: array
                                type: object
                            type: object
                          type: array
                      required:
                        - enabled
                      type: object
                  type: object
                state:
                  default: STARTED
                  enum:
                    - STARTED
                    - STOPPED
                  type: string
                tags:
                  items:
                    type: string
                  type: array
                version:
                  type: string
                visibility:
                  default: PRIVATE
                  enum:
                    - PUBLIC
                    - PRIVATE
                  type: string
              type: object
            status:
              description: ApiDefinitionStatus defines the observed state of API Definition.
              properties:
                crossId:
                  type: string
                environmentId:
                  type: string
                generation:
                  description: This field is kept for backward compatibility and shall be removed
                    in future versions. Use observedGeneration instead.
                  format: int64
                  type: integer
                id:
                  description: The ID of the API definition in the Gravitee API Management
                    instance (if an API context has been configured).
                  type: string
                observedGeneration:
                  format: int64
                  type: integer
                organizationId:
                  type: string
                processingStatus:
                  description: The processing status of the API definition.
                  enum:
                    - Completed
                    - Failed
                  type: string
                state:
                  description: The state of the API. Can be either STARTED or STOPPED.
                  type: string
                status:
                  description: This field is kept for backward compatibility and shall be removed
                    in future versions. Use processingStatus instead.
                  enum:
                    - Completed
                    - Failed
                  type: string
              type: object
          type: object
      served: true
      storage: true
      subresources:
        status: {}
