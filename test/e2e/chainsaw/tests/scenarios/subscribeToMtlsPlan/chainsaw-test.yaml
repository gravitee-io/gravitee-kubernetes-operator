# Copyright (C) 2015 The Gravitee team (http://gravitee.io)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: subscribe-to-mtls-plan
spec:
  bindings:
    - name: commandDir
      value: "../../../../lib/commands"
    - name: gkoNamespace
      value: default

  steps:
    - name: Deploy Secret
      try:
        - apply:
            file: resources/tls-client.yaml
      catch:
        - events: {}
      cleanup:
        - delete:
            file: resources/tls-client.yaml

    - name: Deploy Application
      use:
        template: ../../../stepTemplates/deploy-and-wait.yaml
        with:
          bindings:
            - name: resourceFile
              value: resources/application.yaml
            - name: apiVersion
              value: gravitee.io/v1alpha1
            - name: kind
              value: Application
            - name: name
              value: echo-client

    - name: Deploy v4 API
      use:
        template: ../../../stepTemplates/deploy-and-wait.yaml
        with:
          bindings:
            - name: resourceFile
              value: resources/api.yaml
            - name: apiVersion
              value: gravitee.io/v1alpha1
            - name: kind
              value: ApiV4Definition
            - name: name
              value: mtls-demo

    - name: Deploy Subscription
      use:
        template: ../../../stepTemplates/deploy-and-wait.yaml
        with:
          bindings:
          - name: resourceFile
            value: resources/subscription.yaml
          - name: apiVersion
            value: gravitee.io/v1alpha1
          - name: kind
            value: Subscription
          - name: name
            value: echo-client-subscription

    - name: Call API endpoint without client auth, expect 401
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
            content: |
              npx --yes --quiet zx "$COMMAND_DIR/callGateway.mjs" --endpoint mtls-demo --status 401 --gateway https://localhost:30084
      catch:
        - podLogs:
            selector: "app.kubernetes.io/component=gateway"
            namespace: ($gkoNamespace)

    - name: Call API endpoint with client auth, expect 200
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
            content: |
              npx --yes --quiet zx "$COMMAND_DIR/callGateway.mjs" --endpoint mtls-demo --status 200 --cert resources/pki/client.crt --key resources/pki/client.key --cacert resources/pki/ca.crt --gateway https://localhost:30084
      catch:
        - podLogs:
            selector: "control-plane=controller-manager"
            namespace: ($gkoNamespace)
            container: manager
        - podLogs:
            selector: "app.kubernetes.io/component=gateway"
            namespace: ($gkoNamespace)

    - name: Delete subscription
      try:
        - delete:
            file: resources/subscription.yaml
      catch:
        - events: {}
        - podLogs:
            selector: "control-plane=controller-manager"
            namespace: ($gkoNamespace)
            container: manager

    - name: Call API endpoint after deleting subscription, expect not 200
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
            content: |
              npx --yes --quiet zx "$COMMAND_DIR/callGateway.mjs" --endpoint mtls-demo --notStatus 200 --cert resources/pki/client.crt --key resources/pki/client.key --cacert resources/pki/ca.crt --gateway https://localhost:30084
      catch:
        - podLogs:
            selector: "app.kubernetes.io/component=gateway"
            namespace: ($gkoNamespace)
