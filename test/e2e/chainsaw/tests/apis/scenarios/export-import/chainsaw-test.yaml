# Copyright (C) 2015 The Gravitee team (http://gravitee.io)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: export-import
spec:
  # A bug (https://github.com/kyverno/chainsaw/issues/2499) in Chainsaw prevents using the apiKind bindings for now.
  # Workaround is to hardcode the value for Kind and add a second test to cover both v2 and v4.
  # Remove second test and use the apiKind binding once the bug is fixed.
  scenarios:
    - bindings:
        - name: apiVersion
          value: v2
        - name: apiVersionK8s
          value: apidefinitions.gravitee.io
        - name: apiKind
          value: ApiDefinition
    # - bindings:
    #     - name: apiVersion
    #       value: v4
    #     - name: apiVersionK8s
    #       value: apiv4definitions.gravitee.io
    #     - name: apiKind
    #       value: ApiV4Definition
  bindings:
    - name: apiName
      value: (join('-', [$apiVersion, 'api-config-rich']))
    - name: apiCrdFile
      value: (join('', ['resources/', $apiName,'.yaml']))
    - name: commandDir
      value: "../../../../commands"
    - name: gkoNamespace
      value: default
    - name: exportedApiYaml
      value: (concat($apiVersion, '-exportedApi.yaml'))

    - name: createdApiJson
      value: createdApi.json
    - name: modifiedYamlExport
      value: modifiedExport.yaml


  steps:
    - name: Create API from JSON file
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
              - name: CREATED_API_JSON
                value: ($createdApiJson)
              - name: API_NAME
                value: ($apiName)
            content: |
              npx zx $COMMAND_DIR/createApiFromJson.mjs --jsonfile resources/$API_NAME.json > $CREATED_API_JSON
      catch:
        - podLogs:
            selector: "app.kubernetes.io/component=api"
            namespace: ($gkoNamespace)

    - name: Export API as YAML
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
              - name: CREATED_API_JSON
                value: ($createdApiJson)
              - name: EXPORTED_API_YAML
                value: ($exportedApiYaml)
              - name: API_VERSION
                value: ($apiVersion)
            content: |
              API_ID=$(cat $CREATED_API_JSON | jq -r '.id')
              npx zx $COMMAND_DIR/exportApiAsYaml.mjs --api_id $API_ID --api_version $API_VERSION > $EXPORTED_API_YAML
      catch:
        - podLogs:
            selector: "app.kubernetes.io/component=api"
            namespace: ($gkoNamespace)
        - script:
            env:
              - name: CREATED_API_JSON
                value: ($createdApiJson)
            content: |
              cat $CREATED_API_JSON

    - name: Add contextRef to exported YAML
      try:
      - script:
          env:
          - name: EXPORTED_API_YAML
            value: ($exportedApiYaml)
          - name: MODIFIED_YAML_EXPORT
            value: modifiedExport.yaml
          - name: GKO_NAMESPACE
            value: ($gkoNamespace)
          content: |
            cat "$EXPORTED_API_YAML" | \
            yq -e ".spec.contextRef = {\"name\": \"dev-ctx\", \"namespace\": \"$GKO_NAMESPACE\"}" > $MODIFIED_YAML_EXPORT

    - name: Deploy modified YAML export
      use:
        template: ../../../../stepTemplates/updateApi.yaml
        with:
          bindings:
            - name: apiCrdFile
              value: ($modifiedYamlExport)

    - name: Update API to STARTED state
      try:
        - patch:
            resource:
              apiVersion: gravitee.io/v1alpha1
              kind: ApiDefinition
              metadata:
                name: ($apiName)
              spec:
                state: "STARTED"
        - assert:
            resource:
              apiVersion: gravitee.io/v1alpha1
              kind: ApiDefinition
              metadata:
                name: ($apiName)
              status:
                state: STARTED
                processingStatus: Completed
      catch:
        - podLogs:
            selector: "control-plane=controller-manager"
            namespace: ($gkoNamespace)
          
    - name: cleanup-generated-files
      try:
        - script:
            env:
              - name: EXPORTED_API_YAML
                value: ($exportedApiYaml)
              - name: MODIFIED_YAML_EXPORT
                value: ($modifiedYamlExport)
              - name: CREATED_API_JSON
                value: ($createdApiJson)
            content: |
              echo "Cleaning up generated files..."
              rm -f "$EXPORTED_API_YAML" "$MODIFIED_YAML_EXPORT" "$CREATED_API_JSON"
