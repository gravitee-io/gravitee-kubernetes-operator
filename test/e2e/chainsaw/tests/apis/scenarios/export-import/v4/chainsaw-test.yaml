# Copyright (C) 2015 The Gravitee team (http://gravitee.io)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: export-import
spec:
  # A bug (https://github.com/kyverno/chainsaw/issues/2499) in Chainsaw prevents using the apiKind bindings for now.
  # Workaround is to hardcode the value for Kind and add a second test to cover both v2 and v4.
  # Remove second test and use the apiKind binding once the bug is fixed.
  scenarios:
    # - bindings:
    #     - name: apiVersion
    #       value: v2
    #     - name: apiVersionK8s
    #       value: apidefinitions.gravitee.io
    #     - name: apiKind
    #       value: ApiDefinition
    - bindings:
        - name: apiVersion
          value: v4
        - name: apiVersionK8s
          value: apiv4definitions.gravitee.io
        - name: apiKind
          value: ApiV4Definition
  bindings:
    - name: apiName
      value: (join('-', [$apiVersion, 'api-config-rich']))
    - name: apiCrdFile
      value: (join('', ['../resources/', $apiName,'.yaml']))
    - name: commandDir
      value: "../../../../../../lib/commands"
    - name: gkoNamespace
      value: default
    - name: exportedApiYaml
      value: (concat($apiVersion, '-exportedApi.yaml'))
    - name: reExportedApiYaml
      value: (concat($apiVersion, '-re-exportedApi.yaml'))

    - name: createdApiJson
      value: createdApi.json
    - name: modifiedYamlExport
      value: modifiedExport.yaml


  steps:
    - name: Create API from JSON file
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
              - name: CREATED_API_JSON
                value: ($createdApiJson)
              - name: API_NAME
                value: ($apiName)
            content: |
              npx --yes --quiet zx $COMMAND_DIR/createApiFromJson.mjs --jsonfile ../resources/$API_NAME.json > $CREATED_API_JSON
      catch:
        - podLogs:
            selector: "app.kubernetes.io/component=api"
            namespace: ($gkoNamespace)    
      cleanup:
        - script:
            env:
              - name: CREATED_API_JSON
                value: ($createdApiJson)
            content: |
              rm -f $CREATED_API_JSON

    - name: Export API as YAML
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
              - name: CREATED_API_JSON
                value: ($createdApiJson)
              - name: EXPORTED_API_YAML
                value: ($exportedApiYaml)
              - name: API_VERSION
                value: ($apiVersion)
            content: |
              API_ID=$(cat $CREATED_API_JSON | jq -r '.id')
              npx --yes --quiet zx $COMMAND_DIR/exportApiAsYaml.mjs --api_id $API_ID --api_version $API_VERSION > $EXPORTED_API_YAML
      catch:
        - podLogs:
            selector: "app.kubernetes.io/component=api"
            namespace: ($gkoNamespace)
        - script:
            env:
              - name: CREATED_API_JSON
                value: ($createdApiJson)
            content: |
              cat $CREATED_API_JSON
      cleanup:
        - script:
            env:
              - name: EXPORTED_API_YAML
                value: ($exportedApiYaml)
            content: |
              rm -f $EXPORTED_API_YAML

    - name: Add contextRef to exported YAML
      try:
        - script:
            env:
              - name: EXPORTED_API_YAML
                value: ($exportedApiYaml)
              - name: MODIFIED_YAML_EXPORT
                value: modifiedExport.yaml
              - name: GKO_NAMESPACE
                value: ($gkoNamespace)
            content: |
              cat "$EXPORTED_API_YAML" | \
              yq -e ".spec.contextRef = {\"name\": \"dev-ctx\", \"namespace\": \"$GKO_NAMESPACE\"}" > $MODIFIED_YAML_EXPORT
      cleanup:
        - script:
            env:
              - name: MODIFIED_YAML_EXPORT
                value: ($modifiedYamlExport)
            content: |
              rm -f $MODIFIED_YAML_EXPORT

    - name: Deploy modified YAML export
      use:
        template: ../../../../../stepTemplates/updateApi.yaml
        with:
          bindings:
            - name: apiCrdFile
              value: ($modifiedYamlExport)

    - name: Update API to STARTED state
      try:
        - patch:
            resource:
              apiVersion: gravitee.io/v1alpha1
              kind: ApiV4Definition
              metadata:
                name: ($apiName)
              spec:
                state: "STARTED"
        - assert:
            resource:
              apiVersion: gravitee.io/v1alpha1
              kind: ApiV4Definition
              metadata:
                name: ($apiName)
              status:
                state: STARTED
                processingStatus: Completed
      catch:
        - podLogs:
            selector: "control-plane=controller-manager"
            namespace: ($gkoNamespace)

    - name: Assert STATE and PLANS in exported API
      use:
        template: ../../../../../stepTemplates/exportApiAndAssert.yaml
        with:
          bindings:
            - name: assertArgs
              value:
                - '--assert spec.state:STARTED'              
                - '--assert spec.plans.Default-Keyless-(UNSECURED).name:"Default Keyless (UNSECURED)"'
                - --assert spec.plans.myApiKeyPlan.name:myApiKeyPlan

    - name: Re-export API after import
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
              - name: CREATED_API_JSON
                value: ($createdApiJson)
              - name: REEXPORTED_API_YAML
                value: ($reExportedApiYaml)
              - name: API_VERSION
                value: ($apiVersion)
            content: |
              API_ID=$(cat $CREATED_API_JSON | jq -r '.id')
              npx --yes --quiet zx $COMMAND_DIR/exportApiAsYaml.mjs --api_id $API_ID --api_version $API_VERSION > $REEXPORTED_API_YAML
      catch:
        - podLogs:
            selector: "app.kubernetes.io/component=api"
            namespace: ($gkoNamespace)
        - script:
            env:
              - name: CREATED_API_JSON
                value: ($createdApiJson)
            content: |
              cat $CREATED_API_JSON
      cleanup:
        - script:
            env:
              - name: REEXPORTED_API_YAML
                value: ($reExportedApiYaml)
            content: |
              rm -f $REEXPORTED_API_YAML

    - name: Compare exported APIs
      try:
        - script:
            env:
              - name: COMMAND_DIR
                value: ($commandDir)
              - name: FIRST_EXPORT
                value: ($exportedApiYaml)
              - name: SECOND_EXPORT
                value: ($reExportedApiYaml)
            content: |
              # Remove ignore flags regarding crossIds once https://github.com/gravitee-io/gravitee-api-management/pull/14544 is merged
              npx --yes --quiet zx $COMMAND_DIR/compareYamlFiles.mjs --first $FIRST_EXPORT --second $SECOND_EXPORT \
                --ignore $.spec.state \
                --ignore $.spec.pages.Aside.crossId \
                --ignore $.spec.pages.markdown_test.crossId
      catch:
        - script:
            env:
              - name: FIRST_EXPORT
                value: ($exportedApiYaml)
              - name: SECOND_EXPORT
                value: ($reExportedApiYaml)
            content: |
              echo "--- First export ---"
              cat "$FIRST_EXPORT"
              echo "--- Second export ---"
              cat "$SECOND_EXPORT"
